---
- hosts: 10.48.168.3
  connection: local
  vars:
    aci_login: &aci_login
      hostname: '{{ inventory_hostname }}'
      username: ansible
      password: random
      use_proxy: no
      use_ssl: yes
      validate_certs: no
  tasks:
  - name: Add a tenant using aci_tenant
    aci_tenant:
      <<: *aci_login
      tenant: leopoldo
      description: 'git push event test'
      state: present

  - name: CREATE ACI TENANT VRF
    aci_vrf:
      <<: *aci_login
      vrf: marcel
      tenant: leopoldo

  - name: Create BD
    aci_bd:
      <<: *aci_login
      tenant: leopoldo
      bd: lenilsou
      vrf: marcel
      arp_flooding: True
      l2_unknown_unicast: proxy
      l3_unknown_multicast: flood
      multi_dest: bd-flood

  - name: CREATE ACI TENANT BD SUBNET 1
    aci_bd_subnet:
      <<: *aci_login
      tenant: leopoldo
      bd: lenilsou
      gateway: 192.168.66.1
      mask: 24

  - name: CREATE ACI TENANT BD SUBNET 2
    aci_bd_subnet:
      <<: *aci_login
      tenant: leopoldo
      bd: lenilsou
      gateway: 192.168.67.1
      mask: 24
  
  - name: CREATE ACI TENANT APP PROFILE
    aci_ap:
      <<: *aci_login
      ap: fonzo
      tenant: leopoldo

  - name: CREATE ACI EPG 1
    aci_epg:
      <<: *aci_login
      epg: tintin
      ap: fonzo
      tenant: leopoldo
      bd: lenilsou

  - name: CREATE ACI EPG 2
    aci_epg:
      <<: *aci_login
      epg: milou
      ap: fonzo
      tenant: leopoldo
      bd: lenilsou

  - name: Associate VMM domain to EPG1
    aci_epg_to_domain:
      <<: *aci_login
      epg: tintin
      ap: fonzo
      tenant: leopoldo
      domain: dot3-vmm
      domain_type: 'vmm'
      vm_provider: 'vmware'
      encap_mode: 'auto'
      resolution_immediacy: 'pre-provision'
      deploy_immediacy: 'immediate'

  - name: Associate VMM domain to EPG2
    aci_epg_to_domain:
      <<: *aci_login
      epg: milou
      ap: fonzo
      tenant: leopoldo
      domain: dot3-vmm
      domain_type: 'vmm'
      vm_provider: 'vmware'
      encap_mode: 'auto'
      resolution_immediacy: 'pre-provision'
      deploy_immediacy: 'immediate'

  - name: Read data from CSV file to be used to configure ACI
    community.general.read_csv:
      path: ports.csv
    register: ports

  - name: deploy static path bindings for an EPG
    cisco.aci.aci_static_binding_to_epg:
      <<: *aci_login
      tenant: '{{ item.tenant }}'
      ap: '{{ item.ap }}'
      epg: '{{ item.epg }}'
      encap_id: '{{ item.encap_id }}'
      deploy_immediacy: '{{ item.deploy }}'
      interface_mode: '{{ item.int_mode }}'
      interface_type: '{{ item.int_type }}'
      pod_id: '{{ item.pod_id }}'
      leafs: '{{ item.leaf }}'
      interface: '{{ item.int }}'
    loop: '{{ ports.list }}'
